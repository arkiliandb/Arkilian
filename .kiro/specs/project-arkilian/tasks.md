# Implementation Plan: Project Arkilian

## Overview

This implementation plan breaks down Project Arkilian into incremental coding tasks. Each task builds on previous work, ensuring no orphaned code. The plan prioritizes core functionality first, with property-based tests validating correctness at each stage.

## Tasks

- [x] 1. Project Setup and Core Types
  - [x] 1.1 Initialize Go module and project structure
    - Create `go.mod` with module `github.com/arkilian/arkilian`
    - Create directory structure: `cmd/`, `internal/`, `pkg/`, `test/`
    - Add dependencies: `github.com/mattn/go-sqlite3`, `github.com/leanovate/gopter`, `github.com/klauspost/compress/snappy`
    - _Requirements: 1.1, 2.1_
  - [x] 1.2 Implement core types in `pkg/types/`
    - Create `row.go` with Row struct (EventID, TenantID, UserID, EventTime, EventType, Payload)
    - Create `schema.go` with Schema, ColumnDef, IndexDef structs
    - Create `partition.go` with PartitionKey, PartitionKeyConfig types
    - _Requirements: 2.3, 12.1, 12.2, 12.3_
  - [x] 1.3 Implement ULID generation in `pkg/types/ulid.go`
    - Implement time-ordered ULID generation using crypto/rand
    - Ensure lexicographic ordering property
    - _Requirements: 2.3_
  - [x] 1.4 Write property test for ULID ordering
    - **Property 8: ULID Time Ordering**
    - **Validates: Requirements 2.3**

- [-] 2. Bloom Filter Implementation
  - [x] 2.1 Implement bloom filter core in `internal/bloom/filter.go`
    - Implement BloomFilter struct with bit array
    - Implement murmur3_128 hashing
    - Implement Add() and Contains() methods
    - Implement optimal size calculation for target FPR
    - _Requirements: 1.4, 3.3, 3.4_
  - [x] 2.2 Implement bloom filter serialization in `internal/bloom/serialization.go`
    - Implement Serialize() returning base64-encoded bytes
    - Implement Deserialize() reconstructing filter from bytes
    - _Requirements: 3.5_
  - [ ] 2.3 Write property tests for bloom filter
    - **Property 1: Bloom Filter Membership Guarantee**
    - **Property 2: Bloom Filter False Positive Rate Bounds**
    - **Property 3: Bloom Filter Serialization Round-Trip**
    - **Validates: Requirements 1.4, 3.3, 3.4, 3.5**

- [x] 3. Checkpoint - Verify bloom filter implementation
  - Ensure all bloom filter tests pass, ask the user if questions arise.

- [x] 4. Partition Builder Implementation
  - [x] 4.1 Implement partition builder in `internal/partition/builder.go`
    - Implement PartitionBuilder interface
    - Create SQLite file with WITHOUT ROWID optimization
    - Create optimized indexes (tenant_time, user_time)
    - Implement row insertion with Snappy compression for payloads
    - _Requirements: 1.2, 2.2, 2.4, 2.5_
  - [x] 4.2 Implement statistics computation in `internal/partition/stats.go`
    - Compute min/max values for indexed columns during build
    - Track row count and size
    - _Requirements: 1.3, 3.2_
  - [x] 4.3 Implement metadata sidecar generation in `internal/partition/metadata.go`
    - Create MetadataSidecar struct with all required fields
    - Generate bloom filters for tenant_id and user_id columns
    - Serialize to JSON
    - _Requirements: 2.6, 3.1, 3.6_
  - [x] 4.4 Implement schema validation in `internal/partition/validation.go`
    - Validate rows against declared schema
    - Check type constraints and required fields
    - Return detailed validation errors
    - _Requirements: 1.1_
  - [ ]\* 4.5 Write property tests for partition builder
    - **Property 4: Min/Max Statistics Accuracy**
    - **Property 5: Metadata Sidecar Completeness**
    - **Property 6: Metadata Sidecar JSON Round-Trip**
    - **Property 9: Snappy Compression Round-Trip**
    - **Property 10: Schema Validation Correctness**
    - **Validates: Requirements 1.1, 1.3, 2.4, 2.6, 3.1, 3.2, 3.5, 3.6**

- [x] 5. Checkpoint - Verify partition builder
  - Ensure all partition builder tests pass, ask the user if questions arise.

- [x] 6. Object Storage Abstraction
  - [x] 6.1 Implement storage interface in `internal/storage/storage.go`
    - Define ObjectStorage interface (Upload, Download, Delete, Exists)
    - Define UploadMultipart for large files
    - Define ConditionalPut for atomic operations
    - _Requirements: 11.1, 11.2, 11.4_
  - [x] 6.2 Implement S3 storage in `internal/storage/s3.go`
    - Implement ObjectStorage interface for AWS S3
    - Use AWS SDK v2 for Go
    - Implement multipart upload with ETag validation
    - Implement retry logic with exponential backoff
    - _Requirements: 11.1, 11.2, 11.3_
  - [x] 6.3 Implement local filesystem storage for testing in `internal/storage/local.go`
    - Implement ObjectStorage interface using local filesystem
    - Support same interface for integration testing
    - _Requirements: 11.1_

- [-] 7. Manifest Catalog Implementation
  - [x] 7.1 Implement catalog schema in `internal/manifest/schema.go`
    - Define SQL schema for partitions table
    - Define indexes for pruning (time, user, tenant, key, size)
    - Define schema_versions and idempotency_keys tables
    - _Requirements: 4.1, 4.2_
  - [x] 7.2 Implement catalog operations in `internal/manifest/catalog.go`
    - Implement Catalog interface
    - Implement RegisterPartition with idempotency key support
    - Implement FindPartitions with predicate-based filtering
    - Implement single-writer locking
    - _Requirements: 4.1, 4.3, 4.6, 14.1_
  - [x] 7.3 Implement partition pruning in `internal/manifest/pruning.go`
    - Implement min/max based pruning queries
    - Exclude compacted partitions via filtered indexes
    - _Requirements: 4.4, 6.2_
  - [ ] 7.4 Write property tests for manifest catalog
    - **Property 11: Manifest Storage Completeness**
    - **Property 12: Compaction Tracking Consistency**
    - **Property 13: Compacted Partition Exclusion**
    - **Property 14: Write Serialization**
    - **Property 39: Idempotency Key Handling**
    - **Validates: Requirements 4.1, 4.3, 4.4, 14.1, 18.3, 18.4**

- [x] 8. Checkpoint - Verify manifest catalog
  - Ensure all manifest catalog tests pass, ask the user if questions arise.

- [x] 9. SQL Parser Implementation
  - [x] 9.1 Implement lexer in `internal/query/parser/lexer.go`
    - Tokenize SQL keywords (SELECT, FROM, WHERE, GROUP BY, ORDER BY, LIMIT)
    - Tokenize operators (=, <, >, <=, >=, <>, BETWEEN, IN, AND, OR)
    - Tokenize identifiers, strings, and numbers
    - _Requirements: 5.1_
  - [x] 9.2 Implement AST nodes in `internal/query/parser/ast.go`
    - Define Statement, Expression interfaces
    - Implement SelectStatement, BinaryExpr, ColumnRef, Literal, AggregateExpr
    - Implement String() method for AST printing
    - _Requirements: 5.1, 5.6_
  - [x] 9.3 Implement recursive descent parser in `internal/query/parser/parser.go`
    - Parse SELECT statements with columns, FROM, WHERE, GROUP BY, ORDER BY, LIMIT
    - Parse expressions with proper precedence
    - Parse aggregate functions (COUNT, SUM, AVG, MIN, MAX)
    - Return descriptive errors for invalid syntax
    - _Requirements: 5.1, 5.5, 5.6_
  - [x] 9.4 Implement predicate extraction in `internal/query/parser/predicates.go`
    - Extract WHERE clause predicates
    - Identify columns in predicates for pruning
    - Support equality, range, IN, and BETWEEN predicates
    - _Requirements: 5.2, 5.3_
  - [ ]\* 9.5 Write property tests for SQL parser
    - **Property 15: SQL Parsing Round-Trip**
    - **Property 16: Predicate Extraction Completeness**
    - **Property 17: Invalid SQL Error Handling**
    - **Property 18: SQL Feature Support**
    - **Validates: Requirements 5.1, 5.2, 5.3, 5.5, 5.6**

- [x] 10. Checkpoint - Verify SQL parser
  - Ensure all SQL parser tests pass, ask the user if questions arise.

- [x] 11. Query Planner and Pruner
  - [x] 11.1 Implement query planner in `internal/query/planner/planner.go`
    - Generate query plan from parsed AST
    - Identify partitions to scan based on predicates
    - _Requirements: 6.1_
  - [x] 11.2 Implement 2-phase pruner in `internal/query/planner/pruner.go`
    - Phase 1: Query manifest with min/max predicates
    - Phase 2: Apply bloom filters to candidate partitions
    - Load bloom filters from metadata sidecars
    - _Requirements: 6.1, 6.2, 6.3_
  - [ ]\* 11.3 Write property tests for pruner
    - **Property 19: Min/Max Pruning Correctness**
    - **Property 20: Bloom Filter Pruning Correctness**
    - **Validates: Requirements 6.2, 6.3**

- [x] 12. Query Executor Implementation
  - [x] 12.1 Implement connection pool in `internal/query/executor/pool.go`
    - Manage SQLite connections to downloaded partitions
    - Support concurrent access with connection limits
    - _Requirements: 7.2_
  - [x] 12.2 Implement parallel executor in `internal/query/executor/executor.go`
    - Execute subqueries across pruned partitions in parallel
    - Download partitions from storage on demand
    - Collect partial results from each partition
    - _Requirements: 7.1, 7.3_
  - [x] 12.3 Implement result merger in `internal/query/executor/merger.go`
    - Merge partial results using stream-oriented UNION ALL
    - Support early termination for LIMIT queries
    - _Requirements: 7.4, 7.5_
  - [ ]\* 12.4 Write property tests for executor
    - **Property 21: Parallel Execution Correctness**
    - **Property 22: Result Merging Completeness**
    - **Property 23: LIMIT Correctness**
    - **Validates: Requirements 7.1, 7.4, 7.5**

- [x] 13. Aggregator Implementation
  - [x] 13.1 Implement partial aggregates in `internal/query/aggregator/partial.go`
    - Compute COUNT, SUM, MIN, MAX per partition
    - Track count and sum for AVG computation
    - _Requirements: 8.1_
  - [x] 13.2 Implement aggregate merger in `internal/query/aggregator/merger.go`
    - Merge partial COUNTs (sum)
    - Merge partial SUMs (sum)
    - Merge partial MINs (minimum)
    - Merge partial MAXs (maximum)
    - Merge partial AVGs (weighted average)
    - _Requirements: 8.2_
  - [x] 13.3 Implement GROUP BY merger in `internal/query/aggregator/groupby.go`
    - Combine groups with same key from different partitions
    - Apply aggregate merging per group
    - _Requirements: 8.3_
  - [x] 13.4 Implement ORDER BY sorter in `internal/query/aggregator/orderby.go`
    - Perform merge sort on partial results
    - Support multiple columns and directions (ASC/DESC)
    - _Requirements: 8.4, 8.5_
  - [ ]\* 13.5 Write property tests for aggregator
    - **Property 24: Partial Aggregate Correctness**
    - **Property 25: Aggregate Merge Correctness**
    - **Property 26: GROUP BY Merge Correctness**
    - **Property 27: ORDER BY Sort Correctness**
    - **Validates: Requirements 8.1, 8.2, 8.3, 8.4, 8.5**

- [x] 14. Checkpoint - Verify query execution
  - Ensure all query execution tests pass, ask the user if questions arise.

- [x] 15. Compaction Daemon Implementation
  - [x] 15.1 Implement compaction candidate selection in `internal/compaction/candidates.go`
    - Find partitions smaller than 8MB
    - Find partition keys with >100 partitions per day
    - _Requirements: 9.1, 9.2_
  - [x] 15.2 Implement partition merger in `internal/compaction/merger.go`
    - Download source partitions
    - Merge data sorted by primary key
    - Generate new partition with combined data
    - Compute new statistics and bloom filters
    - _Requirements: 9.3_
  - [x] 15.3 Implement compaction validation in `internal/compaction/validation.go`
    - Validate row count matches sum of sources
    - Validate checksum of compacted data
    - _Requirements: 10.3_
  - [x] 15.4 Implement compaction daemon in `internal/compaction/daemon.go`
    - Run compaction loop on configurable interval
    - Upload new partition before updating manifest
    - Atomically update compacted_into for sources
    - Support idempotent operations
    - _Requirements: 9.4, 9.5, 10.1, 10.4, 10.5_
  - [x] 15.5 Implement garbage collection in `internal/compaction/gc.go`
    - Find partitions past 7-day TTL
    - Delete from storage only after TTL
    - _Requirements: 9.6_
  - [ ]\* 15.6 Write property tests for compaction
    - **Property 28: Compaction Candidate Selection**
    - **Property 29: Compaction Merge Ordering**
    - **Property 30: Compaction Safety Invariant**
    - **Property 31: Compaction Checksum Validation**
    - **Property 32: Compaction Idempotency**
    - **Property 33: TTL Enforcement**
    - **Validates: Requirements 9.1, 9.2, 9.3, 9.6, 10.1, 10.3, 10.4, 10.5**

- [x] 16. Checkpoint - Verify compaction daemon
  - Ensure all compaction tests pass, ask the user if questions arise.

- [x] 17. Partition Key Routing
  - [x] 17.1 Implement partition key strategies in `internal/partition/routing.go`
    - Implement time-based routing (YYYYMMDD)
    - Implement tenant-based routing
    - Implement hash-based routing (modulo N)
    - _Requirements: 12.1, 12.2, 12.3, 12.4_
  - [ ]\* 17.2 Write property test for partition key routing
    - **Property 34: Partition Key Routing Correctness**
    - **Validates: Requirements 12.1, 12.2, 12.3, 12.4**

- [x] 18. Schema Evolution Support
  - [x] 18.1 Implement schema versioning in `internal/manifest/schema_version.go`
    - Track schema versions in manifest
    - Increment version on schema changes
    - _Requirements: 13.1, 13.2_
  - [x] 18.2 Implement query rewriting in `internal/query/planner/rewriter.go`
    - Detect schema version differences across partitions
    - Rewrite queries for compatibility
    - Return NULL for missing columns in older versions
    - _Requirements: 13.3, 13.4, 13.5_
  - [ ]\* 18.3 Write property tests for schema evolution
    - **Property 35: Schema Version Tracking**
    - **Property 36: Schema Evolution Query Compatibility**
    - **Property 37: Nullable Column Addition**
    - **Property 38: NULL for Missing Columns**
    - **Validates: Requirements 13.1, 13.2, 13.3, 13.4, 13.5**

- [ ] 19. Observability Implementation
  - [ ] 19.1 Implement metrics in `internal/observability/metrics.go`
    - Define Prometheus metrics for ingest (partition_created, size_bytes)
    - Define metrics for query (latency, partitions_scanned, pruning_ratio)
    - Define metrics for compaction (compaction_completed, source_count)
    - _Requirements: 15.1, 15.2, 15.3_
  - [ ] 19.2 Implement structured logging in `internal/observability/logging.go`
    - Use structured logging with correlation IDs
    - Include request context in all log entries
    - _Requirements: 15.4_
  - [ ] 19.3 Implement health checks in `internal/observability/health.go`
    - Expose /health endpoint for load balancer
    - Check manifest database connectivity
    - Check storage connectivity
    - _Requirements: 15.5_
  - [ ]\* 19.4 Write property test for correlation ID logging
    - **Property 43: Correlation ID Logging**
    - **Validates: Requirements 15.4**

- [x] 20. Error Handling Implementation
  - [x] 20.1 Implement error types in `internal/errors/errors.go`
    - Define ArkilianError with category, code, message, retryable flag
    - Define error categories (VALIDATION, STORAGE, MANIFEST, QUERY, COMPACTION)
    - Implement error wrapping and unwrapping
    - _Requirements: 14.1, 14.4_
  - [x] 20.2 Implement reconciliation in `internal/manifest/reconciliation.go`
    - Detect dangling manifest entries
    - Detect orphaned storage objects
    - Generate reconciliation report
    - _Requirements: 14.4_
  - [ ]\* 20.3 Write property test for dangling entry detection
    - **Property 40: Dangling Entry Detection**
    - **Validates: Requirements 14.4**

- [x] 21. HTTP API Implementation
  - [x] 21.1 Implement ingest handler in `internal/api/http/ingest.go`
    - Handle POST /v1/ingest
    - Parse JSON request body
    - Validate partition_key and rows
    - Return partition_id, row_count, size_bytes, request_id
    - _Requirements: 1.5, 1.6, 17.1, 17.4, 17.5_
  - [x] 21.2 Implement query handler in `internal/api/http/query.go`
    - Handle POST /v1/query
    - Parse SQL from request body
    - Execute query and return results
    - Include execution stats in response
    - _Requirements: 17.3, 17.4, 17.5_
  - [x] 21.3 Implement middleware in `internal/api/http/middleware.go`
    - Add request_id to all requests
    - Add correlation ID for logging
    - Handle errors and return appropriate status codes
    - _Requirements: 17.4, 17.5, 17.6_
  - [ ]\* 21.4 Write property tests for API
    - **Property 41: HTTP Status Code Correctness**
    - **Property 42: Request ID Presence**
    - **Validates: Requirements 17.4, 17.5**

- [x] 22. gRPC API Implementation
  - [x] 22.1 Define protobuf schemas in `api/proto/arkilian.proto`
    - Define IngestRequest and IngestResponse messages
    - Define IngestService with BatchIngest RPC
    - _Requirements: 17.2_
  - [x] 22.2 Implement gRPC server in `internal/api/grpc/ingest.go`
    - Implement IngestService
    - Handle batch ingestion via gRPC
    - _Requirements: 17.2_

- [x] 23. Concurrency and Graceful Shutdown
  - [x] 23.1 Implement concurrent write handling in `internal/partition/concurrent.go`
    - Support concurrent writes to different partition keys
    - Ensure isolation between concurrent operations
    - _Requirements: 18.1_
  - [x] 23.2 Implement graceful shutdown in `internal/server/shutdown.go`
    - Handle SIGTERM/SIGINT signals
    - Complete in-flight requests before shutdown
    - Close database connections cleanly
    - _Requirements: 18.6_
  - [ ]\* 23.3 Write property tests for concurrency
    - **Property 44: Concurrent Write Isolation**
    - **Property 45: Concurrent Query Correctness**
    - **Property 46: Graceful Shutdown Completion**
    - **Validates: Requirements 18.1, 18.2, 18.6**

- [x] 24. Checkpoint - Verify API and concurrency
  - Ensure all API and concurrency tests pass, ask the user if questions arise.

- [x] 25. Service Binaries
  - [x] 25.1 Implement arkilian-ingest binary in `cmd/arkilian-ingest/main.go`
    - Initialize storage, manifest, partition builder
    - Start HTTP and gRPC servers
    - Configure metrics and logging
    - _Requirements: 1.7, 1.8_
  - [x] 25.2 Implement arkilian-query binary in `cmd/arkilian-query/main.go`
    - Initialize storage, manifest, query executor
    - Start HTTP server
    - Load bloom filters on startup
    - Configure metrics and logging
    - _Requirements: 6.5, 7.6_
  - [x] 25.3 Implement arkilian-compact binary in `cmd/arkilian-compact/main.go`
    - Initialize storage, manifest, compaction daemon
    - Start compaction loop
    - Configure metrics and logging
    - _Requirements: 9.1, 9.2_

- [x] 26. Integration Tests
  - [x] 26.1 Write integration tests for ingest flow in `test/integration/ingest_test.go`
    - Test end-to-end ingest: API → partition → storage → manifest
    - Test idempotency key handling
    - _Requirements: 1.1-1.8, 14.1_
  - [x] 26.2 Write integration tests for query flow in `test/integration/query_test.go`
    - Test end-to-end query: API → parse → prune → execute → merge
    - Test partition pruning effectiveness
    - _Requirements: 5.1-8.5_
  - [x] 26.3 Write integration tests for compaction flow in `test/integration/compaction_test.go`
    - Test end-to-end compaction: candidates → merge → upload → manifest
    - Test TTL enforcement
    - _Requirements: 9.1-10.5_

- [x] 27. Final Checkpoint - Full system verification
  - Ensure all tests pass, ask the user if questions arise.
  - Verify performance targets with benchmark tests.

## Notes

- Tasks marked with `*` are optional and can be skipped for faster MVP
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties (46 total)
- Unit tests validate specific examples and edge cases
- Integration tests verify component interactions
